<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片预览系统 - 直接选择文件夹</title>
    <link rel="stylesheet" href="/css/style.css">
    <style>
        /* 优化文件夹选择页面样式 */
        .login-box h3 {
            margin-bottom: 30px;
            color: #666;
            font-size: 20px;
            font-weight: 500;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            margin-bottom: 12px;
            font-size: 18px;
        }
        
        .folder-selection-container {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            align-items: stretch;
        }
        
        .folder-selection-container input[type="text"] {
            flex: 1;
            padding: 18px 20px;
            font-size: 16px;
            text-align: left;
            background-color: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            transition: all 0.3s ease;
        }
        
        .folder-selection-container input[type="text"]:focus {
            border-color: #4CAF50;
            background-color: #fff;
        }
        
        .folder-selection-container button {
            width: auto;
            padding: 18px 30px;
            font-size: 18px;
            white-space: nowrap;
        }
        
        .login-btn {
            margin-top: 15px;
            font-size: 20px;
            padding: 18px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .folder-selection-container {
                flex-direction: column;
            }
            
            .folder-selection-container button {
                width: 100%;
            }
            
            .login-box {
                padding: 30px 25px;
            }
        }
        
        /* 直接选择按钮样式 */
        .direct-select-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 20px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            width: 100%;
        }
        
        .direct-select-btn:hover {
            background-color: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }
        
        .direct-select-btn:active {
            transform: translateY(0);
        }
        
        /* 说明文本样式 */
        .info-text {
            margin-top: 20px;
            font-size: 14px;
            color: #666;
            line-height: 1.5;
        }
        
        /* 切换方式链接 */
        .switch-method {
            margin-top: 30px;
            font-size: 14px;
            color: #666;
        }
        
        .switch-method a {
            color: #4CAF50;
            text-decoration: none;
            font-weight: 500;
        }
        
        .switch-method a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-box">
            <h2>图片预览系统</h2>
            
            <div class="form-group">
                <p class="info-text">
                    点击下方按钮选择文件夹，系统将自动读取并显示图片。
                </p>
                
                <button type="button" 
                        class="direct-select-btn" 
                        onclick="directSelectFolder()">选择文件夹</button>
                
                <div class="switch-method">
                    或者 <a href="/select-folder">手动输入路径</a>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // 选择文件夹并显示图片
        async function directSelectFolder() {
            try {
                // 检查浏览器支持
                if (!('showDirectoryPicker' in window)) {
                    alert('您的浏览器不支持此功能，请更换为Chrome/Edge浏览器或使用手动输入路径方式');
                    return;
                }
                
                // 选择文件夹
                const directoryHandle = await window.showDirectoryPicker();
                
                // 读取图片文件
                const imageFiles = [];
                const maxImages = 50; // 设置最大图片数量限制，允许展示更多图片
                let imageCount = 0;
                
                for await (const [name, handle] of directoryHandle.entries()) {
                    if (handle.kind === 'file' && isImageFile(name)) {
                        // 超过最大图片数量限制时停止读取
                        if (imageCount >= maxImages) {
                            break;
                        }
                        
                        const file = await handle.getFile();
                        imageFiles.push({
                            name: name,
                            file: file,
                            url: URL.createObjectURL(file)
                        });
                        imageCount++;
                    }
                }
                
                if (imageFiles.length === 0) {
                    alert('所选文件夹中没有图片文件');
                    return;
                }
                
                // 如果有超过maxImages张图片，显示提示
                if (imageCount >= maxImages) {
                    alert(`所选文件夹中图片超过${maxImages}张，仅显示前${maxImages}张`);
                }
                
                // 存储图片信息并跳转到预览页面
                sessionStorage.setItem('directSelectedImages', JSON.stringify(imageFiles));
                sessionStorage.setItem('selectedFolderName', directoryHandle.name);
                window.location.href = '/direct-gallery';
            } catch (error) {
                console.error('选择文件夹失败:', error);
                if (error.name !== 'AbortError') {
                    alert('选择文件夹失败，请重试');
                }
            }
        }
        
        // 检查是否为图片文件
        function isImageFile(fileName) {
            const lowerCaseFileName = fileName.toLowerCase();
            return lowerCaseFileName.endsWith('.jpg') ||
                   lowerCaseFileName.endsWith('.jpeg') ||
                   lowerCaseFileName.endsWith('.png') ||
                   lowerCaseFileName.endsWith('.gif') ||
                   lowerCaseFileName.endsWith('.bmp') ||
                   lowerCaseFileName.endsWith('.svg');
        }
    </script>
</body>
</html>